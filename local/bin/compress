#!/bin/bash

FORMAT_ERROR="\e[1;31m[ERROR]"
FORMAT_SUCCESS="\e[1;32m[SUCCESS]"
FORMAT_TITLE="\e[0;34m"
FORMAT_END="\e[0m"

function help() {
	printf "
${FORMAT_TITLE}USAGE:${FORMAT_END}
    $(basename $0) [-o OUTPUT_FILE] [-l COMPRESSION_LEVEL] INPUT_FILE

${FORMAT_TITLE}DESCRIPTION:${FORMAT_END}
    Compresses a video file using ffmpeg with a specified compression level.

${FORMAT_TITLE}ARGUMENTS:${FORMAT_END}
    -o OUTPUT_FILE         Specify the name of the output file. (Optional)
    -l COMPRESSION_LEVEL   Compression level (0-3). (Optional)
                           0: Low compression (default)
                           1: Medium compression
                           2: High compression
                           3: Maximum compression
    INPUT_FILE             The video file to be compressed.

${FORMAT_TITLE}EXAMPLES:${FORMAT_END}
    $(basename $0) -o output.mkv -l 2 input.mp4
    $(basename $0) input.mp4

${FORMAT_TITLE}REPORTING BUGS:${FORMAT_END}
    Report issues at: https://github.com/druxorey/dotfiles/issues

"
    exit 1
}


function main() {
	local inputFile=""
	local outputFile=""
	local compressionLevel=0

	while getopts "o:l:h" opt; do
		case $opt in
			o) outputFile="$OPTARG" ;;
			l) compressionLevel="$OPTARG" ;;
			h) help ;;
			*) help ;;
		esac
	done

	shift $((OPTIND - 1))

	inputFile="$1"

	if [[ -z "$inputFile" ]]; then
		printf "${FORMAT_ERROR} Input file is required${FORMAT_END}\n"
		return 1
	fi

	if [[ -z "$outputFile" ]]; then
		local date=$(date +%d-%m-%Y_%H-%M-%S)
		outputFile="${compressionLevel}_${date}.${inputFile#*.}"
	fi

	case $compressionLevel in
		0) compression=10 ;;
		1) compression=20 ;;
		2) compression=31 ;;
		3) compression=35 ;;
		*) printf "${FORMAT_ERROR} Wrong compression level${FORMAT_END}\n" ; return 1 ;;
	esac

	ffmpeg -i "$inputFile" -vcodec libx264 -preset slower -crf $compression "$outputFile" || {
		printf "${FORMAT_ERROR} Failed to compress the file${FORMAT_END}\n"
		return 1
	}

	printf "\n${FORMAT_SUCCESS} File $inputFile compressed to $outputFile with compression level $compressionLevel${FORMAT_END}\n"
}

main "$@"
