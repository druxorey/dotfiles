#!/bin/bash

declare FORMAT_SUCCESS="\e[1;32m[SUCCESS]"
declare FORMAT_WARNING="\e[1;33m[WARNING]"
declare FORMAT_ERROR="\e[1;31m[ERROR]"
declare FORMAT_TITLE="\e[0;34m"
declare FORMAT_RESET="\e[0m"

function help() {
	printf "
${FORMAT_TITLE}USAGE:${FORMAT_RESET}
	$(basename $0) [-o OUTPUT_FILE] [-l COMPRESSION_LEVEL] INPUT_FILE

${FORMAT_TITLE}DESCRIPTION:${FORMAT_RESET}
	Compresses a video file using ffmpeg with a specified compression level.

${FORMAT_TITLE}ARGUMENTS:${FORMAT_RESET}
	-o OUTPUT_FILE         Specify the name of the output file. (Optional)
	-l COMPRESSION_LEVEL   Compression level (0-3). (Optional)
						   0: Low compression (default)
						   1: Medium compression
						   2: High compression
						   3: Maximum compression
	INPUT_FILE             The video file to be compressed.

${FORMAT_TITLE}EXAMPLES:${FORMAT_RESET}
	$(basename $0) -o output.mkv -l 2 input.mp4
	$(basename $0) input.mp4

${FORMAT_TITLE}REPORTING BUGS:${FORMAT_RESET}
	Report issues at: https://github.com/druxorey/dotfiles/issues

"
	exit 0
}


function main() {
	local outputFile="default.mp4"
	local compressionLevel=0
	local compression=10

	while getopts "o:l:h" opt; do
		case $opt in
			o) outputFile="$OPTARG" ;;
			l) compressionLevel="$OPTARG" ;;
			h) help ;;
			*) exit 1 ;;
		esac
	done

	shift $((OPTIND - 1))

	local inputFile="$1"

	if [[ -z "$inputFile" ]]; then
		printf "${FORMAT_ERROR} Input file is required${FORMAT_RESET}\n"
		exit 1
	fi

	if [[ -z "$outputFile" ]]; then
		date=$(date +%d-%m-%Y_%H-%M-%S)
		outputFile="${compressionLevel}_${date}.${inputFile#*.}"
	fi

	if [[ $compressionLevel == 0 ]]; then
		printf "${FORMAT_WARNING} Compression level is set to %s, which means no compression will be applied. Proceeding with default settings.${FORMAT_RESET}\n" "$compressionLevel"
	else
		printf "Compression level is set to %s\n" "$compressionLevel"
	fi

	case $compressionLevel in
		0) compression=10 ;;
		1) compression=20 ;;
		2) compression=31 ;;
		3) compression=35 ;;
		*) printf "${FORMAT_ERROR} Wrong compression level '%s'. Valid options [0,1,2,3]${FORMAT_RESET}\n" "$compressionLevel" ; exit 1 ;;
	esac

	ffmpeg -i "$inputFile" -vcodec libx264 -preset slower -crf $compression "$outputFile" || {
		printf "${FORMAT_ERROR} Failed to compress the file '%s' ${FORMAT_RESET}\n" "$inputFile"
		exit 1
	}

	printf "\n${FORMAT_SUCCESS} File '%s' compressed to '%s' with compression level %s${FORMAT_RESET}\n" "$inputFile" "$outputFile" "$compressionLevel"

	return 0
}

main "$@"
